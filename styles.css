document.addEventListener("DOMContentLoaded", () => {
  const form = document.getElementById("planner-form");
  const warningsEl = document.getElementById("warnings");
  const resultsEl = document.getElementById("results");

  const spendModeSelect = document.getElementById("spendMode");
  const withdrawRateField = document.getElementById("withdrawRateField");
  const fixedSpendingField = document.getElementById("fixedSpendingField");

  const currentCashInput = document.getElementById("currentCash");
  const currentBondsInput = document.getElementById("currentBonds");
  const currentUSInput = document.getElementById("currentUS");
  const currentIntlInput = document.getElementById("currentIntl");

  const withdrawalRateInput = document.getElementById("withdrawalRate");
  const fixedSpendingInput = document.getElementById("fixedSpending");
  const bucket1YearsInput = document.getElementById("bucket1Years");
  const bucket2YearsInput = document.getElementById("bucket2Years");
  const desiredStockPctInput = document.getElementById("desiredStockPct");
  const usStockSplitInput = document.getElementById("usStockSplit");

  function getNumber(input, fallback = 0) {
    const v = parseFloat(input.value);
    return Number.isFinite(v) ? v : fallback;
  }

  function formatCurrency(value) {
    if (!Number.isFinite(value)) return "-";
    return value.toLocaleString(undefined, {
      style: "currency",
      currency: "USD",
      maximumFractionDigits: 0
    });
  }

  function formatPercent(value) {
    if (!Number.isFinite(value)) return "-";
    return value.toFixed(1) + " %";
  }

  function clearWarnings() {
    warningsEl.innerHTML = "";
  }

  function addWarning(text) {
    const div = document.createElement("div");
    div.className = "warning";
    div.textContent = text;
    warningsEl.appendChild(div);
  }

  function handleSpendModeChange() {
    const mode = spendModeSelect.value;
    if (mode === "percent") {
      withdrawRateField.classList.remove("hidden");
      fixedSpendingField.classList.add("hidden");
    } else {
      withdrawRateField.classList.add("hidden");
      fixedSpendingField.classList.remove("hidden");
    }
  }

  spendModeSelect.addEventListener("change", () => {
    handleSpendModeChange();
    calculate();
  });

  function calculate() {
    clearWarnings();

    const currentCash = Math.max(0, getNumber(currentCashInput, 0));
    const currentBonds = Math.max(0, getNumber(currentBondsInput, 0));
    const currentUS = Math.max(0, getNumber(currentUSInput, 0));
    const currentIntl = Math.max(0, getNumber(currentIntlInput, 0));

    const P = currentCash + currentBonds + currentUS + currentIntl;

    if (P <= 0) {
      resultsEl.innerHTML = `<p class="muted">Enter some non-zero holdings to see results.</p>`;
      return;
    }

    const mode = spendModeSelect.value;
    let S = 0;
    let wrate = 0;

    if (mode === "percent") {
      wrate = getNumber(withdrawalRateInput, 4);
      if (wrate <= 0) {
        addWarning("Withdrawal rate must be greater than 0% when using percentage mode.");
        resultsEl.innerHTML = `<p class="muted">Adjust the withdrawal rate to continue.</p>`;
        return;
      }
      S = (wrate / 100) * P;
    } else {
      S = getNumber(fixedSpendingInput, 0);
      if (S <= 0) {
        addWarning("Annual spending must be greater than $0 when using fixed amount mode.");
        resultsEl.innerHTML = `<p class="muted">Adjust the annual spending to continue.</p>`;
        return;
      }
      wrate = (S / P) * 100;
    }

    const bucket1Years = Math.max(0, getNumber(bucket1YearsInput, 2));
    const bucket2Years = Math.max(0, getNumber(bucket2YearsInput, 8));

    // Bucket targets based on spending
    const B1_target = S * bucket1Years;
    const B2_target = S * bucket2Years;
    let B3_target = P - (B1_target + B2_target);

    if (B3_target < 0) {
      addWarning(
        "Bucket 1 + Bucket 2 targets exceed your total portfolio. Bucket 3 (stocks) is forced to $0. Consider lowering years of spending or your spending amount."
      );
      B3_target = 0;
    }

    const safeTotal = B1_target + B2_target;
    const impliedStockPct = (B3_target / P) * 100;
    const impliedSafePct = (safeTotal / P) * 100;

    const desiredStockPctRaw = getNumber(desiredStockPctInput, 60);
    const desiredStockPct = Math.min(100, Math.max(0, desiredStockPctRaw));

    if (Math.abs(impliedStockPct - desiredStockPct) > 5) {
      addWarning(
        `Your bucket setup implies about ${impliedStockPct.toFixed(
          1
        )}% in stocks, but your desired stock allocation is ${desiredStockPct.toFixed(
          1
        )}%. To align them, adjust years in buckets or your spending level.`
      );
    }

    if (wrate > 6) {
      addWarning(
        `Your effective withdrawal rate is ${wrate.toFixed(
          2
        )}%. Historically, long-term sustainable rates have often been closer to ~3–4%. Higher rates increase the risk of running out of money.`
      );
    }

    const B1_years_actual = S > 0 ? B1_target / S : 0;
    const B2_years_actual = S > 0 ? B2_target / S : 0;
    const B3_years_actual = S > 0 ? B3_target / S : 0;

    // 3-fund split inside Bucket 3
    const usSplitRaw = getNumber(usStockSplitInput, 50);
    const usSplit = Math.min(100, Math.max(0, usSplitRaw));

    const targetStocksTotal = B3_target;
    const targetUS = targetStocksTotal * (usSplit / 100);
    const targetIntl = targetStocksTotal - targetUS;

    const targetCash = B1_target;
    const targetBonds = B2_target;

    const targetStockPctOfP = (targetStocksTotal / P) * 100;
    const targetBondCashPctOfP = 100 - targetStockPctOfP;

    // Build asset objects for trade calc
    const assets = [
      {
        key: "cash",
        label: "Cash / short-term",
        current: currentCash,
        target: targetCash
      },
      {
        key: "bonds",
        label: "Bond funds",
        current: currentBonds,
        target: targetBonds
      },
      {
        key: "us",
        label: "US stock fund",
        current: currentUS,
        target: targetUS
      },
      {
        key: "intl",
        label: "International stock fund",
        current: currentIntl,
        target: targetIntl
      }
    ];

    // Compute deltas and classify sellers/buyers
    const sellers = [];
    const buyers = [];

    assets.forEach((asset) => {
      const delta = asset.target - asset.current; // + means buy, - means sell
      asset.delta = delta;
      if (delta < -1) {
        sellers.push(asset);
      } else if (delta > 1) {
        buyers.push(asset);
      }
    });

    const trades = [];

    // Simple matching algorithm: move money from sellers to buyers
    sellers.forEach((seller) => {
      let sellRemaining = -seller.delta; // positive
      if (sellRemaining <= 0) return;

      buyers.forEach((buyer) => {
        if (sellRemaining <= 0) return;
        if (buyer.delta <= 0) return;

        const buyNeeded = buyer.delta;
        const amount = Math.min(sellRemaining, buyNeeded);

        if (amount > 1) {
          trades.push({
            from: seller.label,
            to: buyer.label,
            amount
          });

          sellRemaining -= amount;
          seller.delta += amount; // less negative
          buyer.delta -= amount;
        }
      });
    });

    // HTML output
    const allocationHtml = `
      <div class="results-grid">
        <div class="result-block">
          <h3>Totals &amp; Spending</h3>
          <p><span class="result-label">Total portfolio:</span></p>
          <p class="result-value">${formatCurrency(P)}</p>
          <p><span class="result-label">Annual spending (S):</span> ${formatCurrency(S)}</p>
          <p><span class="result-label">Effective withdrawal rate:</span> ${formatPercent(wrate)}</p>
        </div>

        <div class="result-block">
          <h3>Bucket Targets</h3>
          <p><span class="result-label">Bucket 1 (cash) target:</span> ${formatCurrency(
            targetCash
          )} (${B1_years_actual.toFixed(2)} yrs)</p>
          <p><span class="result-label">Bucket 2 (bonds) target:</span> ${formatCurrency(
            targetBonds
          )} (${B2_years_actual.toFixed(2)} yrs)</p>
          <p><span class="result-label">Bucket 3 (stocks) target:</span> ${formatCurrency(
            targetStocksTotal
          )} (${B3_years_actual.toFixed(2)} yrs if used alone)</p>
        </div>

        <div class="result-block">
          <h3>Portfolio Allocation</h3>
          <p><span class="result-label">Target stocks (Bucket 3):</span> ${formatPercent(
            targetStockPctOfP
          )}</p>
          <p><span class="result-label">Target bonds + cash:</span> ${formatPercent(
            targetBondCashPctOfP
          )}</p>
          <p><span class="result-label">Implied from buckets:</span> Stocks ${formatPercent(
            impliedStockPct
          )}, Safe ${formatPercent(impliedSafePct)}</p>
          <p><span class="result-label">Desired stock allocation:</span> ${desiredStockPct.toFixed(
            1
          )} %</p>
        </div>

        <div class="result-block">
          <h3>3-Fund Breakdown</h3>
          <p><span class="result-label">Cash target:</span> ${formatCurrency(targetCash)}</p>
          <p><span class="result-label">Bonds target:</span> ${formatCurrency(targetBonds)}</p>
          <p><span class="result-label">US stocks (${usSplit.toFixed(
            0
          )}% of stocks):</span> ${formatCurrency(targetUS)}</p>
          <p><span class="result-label">Intl stocks (${(100 - usSplit).toFixed(
            0
          )}% of stocks):</span> ${formatCurrency(targetIntl)}</p>
        </div>

        <div class="result-block">
          <h3>Current vs Target (by asset)</h3>
          ${assets
            .map((a) => {
              const diff = a.target - a.current;
              const sign = diff > 0 ? "underweight" : diff < 0 ? "overweight" : "on target";
              return `
                <p>
                  <span class="result-label">${a.label}:</span><br/>
                  Current: ${formatCurrency(a.current)}<br/>
                  Target: ${formatCurrency(a.target)}<br/>
                  Status: ${sign} (${diff > 0 ? "+" : ""}${formatCurrency(diff)})
                </p>
              `;
            })
            .join("")}
        </div>
      </div>
    `;

    let tradesHtml = "";
    if (trades.length === 0) {
      tradesHtml = `<p class="muted">No significant trades needed — you are essentially at target based on these rules.</p>`;
    } else {
      tradesHtml = `
        <p class="section-title">Suggested trades to reach targets</p>
        <ul class="trade-list">
          ${trades
            .map(
              (t) =>
                `<li>Sell <strong>${formatCurrency(
                  t.amount
                )}</strong> from <strong>${t.from}</strong> and buy <strong>${t.to}</strong>.</li>`
            )
            .join("")}
        </ul>
        <p class="muted">
          These are high-level dollar flows. In practice you'd implement them with specific orders
          (e.g., exchange US stock fund → bond fund inside your account).
        </p>
      `;
    }

    resultsEl.innerHTML = allocationHtml + tradesHtml;

    // Save state to localStorage
    const state = {
      currentCash,
      currentBonds,
      currentUS,
      currentIntl,
      mode,
      withdrawalRate: getNumber(withdrawalRateInput, 4),
      fixedSpending: getNumber(fixedSpendingInput, 0),
      bucket1Years,
      bucket2Years,
      desiredStockPct,
      usStockSplit: usSplit
    };
    try {
      window.localStorage.setItem("bucketThreeFundState", JSON.stringify(state));
    } catch (e) {
      // ignore
    }
  }

  // Restore saved state if present
  try {
    const saved = window.localStorage.getItem("bucketThreeFundState");
    if (saved) {
      const state = JSON.parse(saved);
      if (state && typeof state === "object") {
        if ("currentCash" in state) currentCashInput.value = state.currentCash;
        if ("currentBonds" in state) currentBondsInput.value = state.currentBonds;
        if ("currentUS" in state) currentUSInput.value = state.currentUS;
        if ("currentIntl" in state) currentIntlInput.value = state.currentIntl;
        if ("mode" in state) spendModeSelect.value = state.mode;
        if ("withdrawalRate" in state) withdrawalRateInput.value = state.withdrawalRate;
        if ("fixedSpending" in state && state.fixedSpending > 0)
          fixedSpendingInput.value = state.fixedSpending;
        if ("bucket1Years" in state) bucket1YearsInput.value = state.bucket1Years;
        if ("bucket2Years" in state) bucket2YearsInput.value = state.bucket2Years;
        if ("desiredStockPct" in state) desiredStockPctInput.value = state.desiredStockPct;
        if ("usStockSplit" in state) usStockSplitInput.value = state.usStockSplit;
      }
    }
  } catch (e) {
    // ignore
  }

  handleSpendModeChange();
  calculate();

  form.addEventListener("submit", (event) => {
    event.preventDefault();
    calculate();
  });

  // Live updates
  form.addEventListener("input", () => {
    calculate();
  });
});
